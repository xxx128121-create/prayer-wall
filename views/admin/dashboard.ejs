<%- include('../partials/head', { title: '管理後台', description: '管理後台 - 教會祈禱牆' }) %>
<%- include('../partials/header', { heroSubtitle: '管理後台' }) %>
<%- include('../partials/admin-nav', { activeAdmin: 'dashboard' }) %>

<main class="main">
  <!-- Admin bar -->
  <div class="admin-bar">
    <div class="admin-user">登入為 <strong><%= admin.username %></strong></div>
    <form method="POST" action="/admin/logout" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit" class="btn btn-outline btn-sm">登出</button>
    </form>
  </div>

  <!-- Stats -->
  <div class="stats fade-up">
    <div class="stat-card">
      <div class="stat-number"><%= pendingCount %></div>
      <div class="stat-label">待審批</div>
    </div>
    <div class="stat-card">
      <div class="stat-number"><%= approvedCount %></div>
      <div class="stat-label">已批准</div>
    </div>
    <div class="stat-card">
      <div class="stat-number"><%= expiredCount %></div>
      <div class="stat-label">已過期</div>
    </div>
    <div class="stat-card">
      <div class="stat-number"><%= rejectedCount %></div>
      <div class="stat-label">已拒絕</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button type="button" class="tab active" data-tab="pending">待審批 (<%= pendingCount %>)</button>
    <button type="button" class="tab" data-tab="approved">已批准 (<%= approvedCount %>)</button>
    <button type="button" class="tab" data-tab="expired">已過期 (<%= expiredCount %>)</button>
    <button type="button" class="tab" data-tab="rejected">已拒絕 (<%= rejectedCount %>)</button>
  </div>

  <!-- Pending -->
  <section id="pending" class="tab-content active">
    <% if (pendingPrayers.length === 0) { %>
      <div class="empty-state">
        <div class="empty-icon">&#10003;</div>
        <p class="empty-text">暫無待審批項目</p>
      </div>
    <% } else { %>
      <div class="btn-group" style="margin-bottom:12px;">
        <form method="POST" action="/admin/approve-all" style="flex:1;" onsubmit="return confirm('確認全部批准？');">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <button type="submit" class="btn btn-success btn-block btn-sm">全部批准</button>
        </form>
      </div>
      <div class="prayer-list">
        <% pendingPrayers.forEach(function(prayer) { %>
          <article class="card">
            <div class="card-header">
              <span class="card-name">
                <% if (prayer.display_name) { %>
                  <%= prayer.display_name %>
                <% } else { %>
                  <span class="card-name-anon">匿名</span>
                <% } %>
              </span>
              <span class="card-meta"><%= new Date(prayer.created_at).toLocaleString('zh-HK') %></span>
            </div>
            <div class="duration-info">申請顯示 <%= prayer.duration_days || 7 %> 日</div>
            <div class="card-content"><%= prayer.content %></div>
            <details class="edit-panel">
              <summary class="edit-toggle">編輯</summary>
              <form method="POST" action="/admin/edit/<%= prayer.id %>" class="edit-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="form-group">
                  <label class="form-label" for="pendingName-<%= prayer.id %>">署名（可選）</label>
                  <input type="text" id="pendingName-<%= prayer.id %>" name="displayName" class="form-input"
                    maxlength="50" value="<%= prayer.display_name || '' %>">
                </div>
                <div class="form-group">
                  <label class="form-label" for="pendingContent-<%= prayer.id %>">代禱內容 *</label>
                  <textarea id="pendingContent-<%= prayer.id %>" name="content" class="form-textarea"
                    required maxlength="1000"><%= prayer.content %></textarea>
                </div>
                <button type="submit" class="btn btn-outline btn-sm">儲存</button>
              </form>
            </details>
            <div class="btn-group">
              <form method="POST" action="/admin/approve/<%= prayer.id %>" style="flex:1;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-success btn-block btn-sm">批准</button>
              </form>
              <form method="POST" action="/admin/reject/<%= prayer.id %>" style="flex:1;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-danger btn-block btn-sm">拒絕</button>
              </form>
            </div>
          </article>
        <% }); %>
      </div>
    <% } %>
  </section>

  <!-- Approved -->
  <section id="approved" class="tab-content">
    <% if (approvedPrayers.length === 0) { %>
      <div class="empty-state">
        <div class="empty-icon">&#x271D;</div>
        <p class="empty-text">暫無已批准代禱</p>
      </div>
    <% } else { %>
      <div class="prayer-list">
        <% approvedPrayers.forEach(function(prayer) {
          const expiresAt = prayer.expires_at ? new Date(prayer.expires_at) : null;
          const approvedAt = new Date(prayer.approved_at);
          const now = new Date();
          const daysLeft = expiresAt ? Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24)) : null;
          const todayStr = new Date().toISOString().split('T')[0];
          const expiresStr = expiresAt ? expiresAt.toISOString().split('T')[0] : todayStr;
        %>
          <article class="card">
            <div class="card-header">
              <span class="card-name">
                <% if (prayer.display_name) { %>
                  <%= prayer.display_name %>
                <% } else { %>
                  <span class="card-name-anon">匿名</span>
                <% } %>
                <% if (daysLeft !== null) { %>
                  <span class="badge <%= daysLeft <= 2 ? 'badge-warning' : 'badge-ok' %>">
                    <%= daysLeft %> 日後過期
                  </span>
                <% } %>
              </span>
              <span class="card-meta">批准於 <%= approvedAt.toLocaleDateString('zh-HK') %></span>
            </div>
            <% if (expiresAt) { %>
              <div class="date-range">
                <%= approvedAt.toLocaleDateString('zh-HK') %> &mdash; <%= expiresAt.toLocaleDateString('zh-HK') %>
              </div>
            <% } %>
            <div class="card-content"><%= prayer.content %></div>
            <details class="edit-panel">
              <summary class="edit-toggle">編輯</summary>
              <form method="POST" action="/admin/edit/<%= prayer.id %>" class="edit-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <div class="form-group">
                  <label class="form-label" for="approvedName-<%= prayer.id %>">署名（可選）</label>
                  <input type="text" id="approvedName-<%= prayer.id %>" name="displayName" class="form-input"
                    maxlength="50" value="<%= prayer.display_name || '' %>">
                </div>
                <div class="form-group">
                  <label class="form-label" for="approvedContent-<%= prayer.id %>">代禱內容 *</label>
                  <textarea id="approvedContent-<%= prayer.id %>" name="content" class="form-textarea"
                    required maxlength="1000"><%= prayer.content %></textarea>
                </div>
                <button type="submit" class="btn btn-outline btn-sm">儲存</button>
              </form>
            </details>
            <div class="btn-group">
              <form method="POST" action="/admin/set-expiry/<%= prayer.id %>" class="inline-date-form" style="flex:2;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="date" name="expiresAt" class="form-input form-input-compact" min="<%= todayStr %>" value="<%= expiresStr %>" required>
                <button type="submit" class="btn btn-outline btn-sm">更新日期</button>
              </form>
              <form method="POST" action="/admin/reject/<%= prayer.id %>" style="flex:1;"
                onsubmit="return confirm('確定要刪除此代禱？');">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-danger btn-sm btn-block">刪除</button>
              </form>
            </div>
          </article>
        <% }); %>
      </div>
    <% } %>
  </section>

  <!-- Expired -->
  <section id="expired" class="tab-content">
    <div class="alert alert-info mb-md">已過期的代禱不會再顯示在公開祈禱牆。你可以延長它們。</div>
    <% if (expiredPrayers.length === 0) { %>
      <div class="empty-state">
        <div class="empty-icon">&#8986;</div>
        <p class="empty-text">暫無已過期代禱</p>
      </div>
    <% } else { %>
      <div class="prayer-list">
        <% expiredPrayers.forEach(function(prayer) { %>
          <article class="card card-expired">
            <div class="card-header">
              <span class="card-name">
                <% if (prayer.display_name) { %><%= prayer.display_name %><% } else { %><span class="card-name-anon">匿名</span><% } %>
              </span>
              <span class="card-meta">過期於 <%= new Date(prayer.expires_at).toLocaleDateString('zh-HK') %></span>
            </div>
            <div class="card-content"><%= prayer.content %></div>
            <div class="btn-group">
              <form method="POST" action="/admin/extend/<%= prayer.id %>">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-gold btn-sm">重新上架 (+7 日)</button>
              </form>
            </div>
          </article>
        <% }); %>
      </div>
    <% } %>
  </section>

  <!-- Rejected -->
  <section id="rejected" class="tab-content">
    <div class="alert alert-info mb-md">已拒絕的代禱會保留 60 日作記錄，之後自動刪除。</div>
    <% if (rejectedPrayers.length === 0) { %>
      <div class="empty-state">
        <div class="empty-icon">&#128465;</div>
        <p class="empty-text">暫無已拒絕代禱</p>
      </div>
    <% } else { %>
      <div class="prayer-list">
        <% rejectedPrayers.forEach(function(prayer) {
          const todayStr = new Date().toISOString().split('T')[0];
          const recoverStr = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        %>
          <article class="card card-rejected">
            <div class="card-header">
              <span class="card-name">
                <% if (prayer.display_name) { %><%= prayer.display_name %><% } else { %><span class="card-name-anon">匿名</span><% } %>
              </span>
              <span class="card-meta">
                拒絕於 <%= new Date(prayer.approved_at).toLocaleDateString('zh-HK') %> by <%= prayer.approved_by %>
              </span>
            </div>
            <div class="card-content"><%= prayer.content %></div>
            <div class="btn-group">
              <form method="POST" action="/admin/recover/<%= prayer.id %>" class="inline-date-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="date" name="expiresAt" class="form-input form-input-compact" min="<%= todayStr %>" value="<%= recoverStr %>" required>
                <button type="submit" class="btn btn-outline btn-sm">恢復</button>
              </form>
            </div>
          </article>
        <% }); %>
      </div>
    <% } %>
  </section>
</main>

<%- include('../partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var tabs = document.querySelectorAll('.tab');
    var contents = document.querySelectorAll('.tab-content');

    function switchTab(id) {
      tabs.forEach(function(t) { t.classList.toggle('active', t.dataset.tab === id); });
      contents.forEach(function(c) { c.classList.toggle('active', c.id === id); });
    }

    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() { switchTab(this.dataset.tab); });
    });

    if (window.location.hash) {
      var id = window.location.hash.substring(1);
      if (document.getElementById(id)) switchTab(id);
    }
  });
</script>
