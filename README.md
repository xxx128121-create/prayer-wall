# 教會祈禱牆 Prayer Wall

一個安全、可審批的 Web 祈禱牆系統。

## 功能

- 會眾可匿名或署名提交代禱
- Admin 審批後代禱才會公開
- 所有操作有 audit log
- 手機友好設計
- 無需安裝 App

## 快速開始

### 1. 安裝

確保已安裝 Node.js（建議 v18 或以上）

```bash
npm install
```

### 2. 設定

建立 `.env` 並填入以下內容（本機開發可用 SQLite；正式環境建議 Supabase/Postgres）：

```env
PORT=3000
SESSION_SECRET=your-super-secret-session-key-change-this
ADMIN_USERNAME=admin
ADMIN_PASSWORD=changeme123
NODE_ENV=production
STORAGE_BACKEND=supabase
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DATABASE
```

重要設定：
- `SESSION_SECRET`: 改成一個長的隨機字串（用來簽署 session）
- `ADMIN_USERNAME`: Admin 帳號
- `ADMIN_PASSWORD`: Admin 密碼（第一次啟動後會 hash 存入 database）
- `STORAGE_BACKEND`: 設為 `supabase`
- `DATABASE_URL`: 使用 Supabase 提供的連線字串（建議用 Pooler 版本）

### 3. 啟動

```bash
npm start
```

打開瀏覽器：`http://localhost:3000`

## 使用 Supabase/Postgres 當資料庫（推薦）

如果你想要更穩定、可擴充的資料庫，同時仍然可以用 Supabase 的 Table View 作為「像試算表」的管理介面：

```env
STORAGE_BACKEND=supabase
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DATABASE
```

注意：
- `DATABASE_URL` 使用 Supabase 提供的連線字串（建議用 Pooler 版本）。
- Supabase 預設需要 SSL。如果你的環境不能用 SSL，可加 `PGSSLMODE=disable`（不建議在正式環境使用）。
- 第一次啟動會自動建立資料表與 Admin 帳號。

## 使用說明

### 會眾

1. 用手機掃 QR code 或直接開 link
2. 點「提交代禱」
3. 填寫代禱內容（可選擇匿名或署名）
4. 等待 Admin 審批

### Admin

1. 去 `/admin/login`
2. 輸入帳號密碼
3. 查看 pending 代禱
4. Approve 或 Reject

## 備份

如果使用 Supabase/Postgres，請用 Supabase Dashboard 的備份或使用 Postgres 備份工具（如 `pg_dump`）。

如果本機開發使用 SQLite，Database 係一個 file：`db/prayer-wall.db`。

## 搬遷

如果要搬去新 server：

1. Copy 成個 `prayer-wall` folder
2. 確保 `.env` 設定正確
3. 執行 `npm install`
4. 執行 `npm start`

## 查看 Log

所有操作記錄喺 `logs/app.jsonl`：

```powershell
# 查看最新 20 行
Get-Content logs\app.jsonl -Tail 20
```

如果你使用 Supabase/Postgres，請用 Supabase Dashboard 或資料庫工具做定期備份。

## 安全設計

- 所有新提交預設 private（PENDING）
- 只有 Admin 可以 approve
- 密碼用 bcrypt hash
- 有 rate limit 防濫用
- 前端無 secrets

詳見 `SECURITY.md`

---

## 使用手冊

### 系統概述

這是什麼？

教會祈禱牆是一個供教會弟兄姊妹分享代禱事項的網站。所有提交的禱告需經過管理員審核後才會公開顯示。

主要功能：
- 提交代禱事項（可選匿名）
- 審核機制（防止不當內容）
- 自動過期（禱告事項會在指定時間後自動下架）
- 投影模式（適合在教會聚會時投影展示）
- 安全保護（防止垃圾訊息、敏感資料洩露）

### 普通用戶功能

#### 1. 瀏覽祈禱牆

網址：`https://你的網站.com/`

- 首頁顯示所有已審核的代禱事項
- 每個卡片顯示：
  - 提交者姓名（或「匿名」）
  - 禱告內容
  - 提交日期

#### 2. 提交代禱事項

步驟：

1. 點擊導航欄的「提交代禱」按鈕
2. 填寫表單：
   - 姓名（可選）：填寫你的名字，或留空以匿名提交
   - 代禱事項（必填）：描述你的禱告需要
3. 重要提醒：
   - 不要包含敏感個人資料（如身份證號、電話號碼、地址等）
   - 系統會自動檢測並警告你是否包含敏感資料
   - 如果包含敏感資料，建議修改後再提交
4. 點擊「提交代禱」
5. 提交後：
   - 你會看到成功訊息
   - 你的禱告會進入待審核狀態
   - 管理員審核通過後，才會在祈禱牆上顯示

#### 3. 提交限制

- 每 5 分鐘只能提交 1 次
- 如果提交過於頻繁，會看到提示訊息

### 管理員功能

#### 1. 登入管理後台

網址：`https://你的網站.com/admin/login`

登入資訊：
- 用戶名：由管理員設定（環境變數 `ADMIN_USERNAME`）
- 密碼：由管理員設定（環境變數 `ADMIN_PASSWORD`）

#### 2. 管理後台界面

登入後會看到四個分頁：

待審核 (Pending)
- 批准：點擊「批准」按鈕，禱告事項會立即出現在祈禱牆上
- 拒絕：點擊「拒絕」按鈕，禱告事項不會顯示（會保留在「已拒絕」分頁中）
- 編輯：點擊「編輯」可修改內容或姓名（例如移除敏感資料後再批准）
- 設定到期日：選擇禱告事項的到期日期（預設為 7 天後）

提示：
- 如果提交內容包含敏感資料，會顯示警告標誌
- 建議聯繫提交者或編輯移除敏感資料後再批准

已批准 (Approved)
- 設定到期日：修改禱告事項的到期時間
- 延長 7 天：快速將到期日延長 7 天
- 拒絕：將禱告事項下架

已過期 (Expired)
- 延長 7 天：重新激活並延長 7 天

已拒絕 (Rejected)
- 恢復：將禱告事項重新批准並設定到期日

#### 3. 祈禱摘要生成器

網址：`https://你的網站.com/admin/digest`

用途：生成純文字版本的禱告清單，適合：
- 印製成紙本分發給弟兄姊妹
- 在週報中刊登
- 通過電郵發送

步驟：
1. 訪問摘要頁面
2. 系統自動生成所有有效禱告的清單
3. 點擊「複製文字」按鈕
4. 貼到 Word/Email 等處使用

#### 4. 登出

點擊右上角的「登出」按鈕。

### 投影模式

什麼是投影模式？

投影模式是一個全屏的祈禱牆展示界面，設計用於：
- 教會主日崇拜前/後展示
- 禱告會中集體代禱
- 投影在大屏幕上供會眾瀏覽

如何進入投影模式？

方法 1：點擊導航欄的「投影模式」按鈕

方法 2：直接訪問 `https://你的網站.com/display`

投影模式特色

設計：
- 深色背景，適合投影
- 彩色便條紙風格
- 6 種顏色隨機分配（金色、藍色、粉紅、綠色、橙色、紫色）
- 動態字體大小（短禱告用大字，長禱告用小字）

分頁系統：
- 每頁最多 9 個禱告事項（避免重疊）
- 自動輪播，每頁停留 10 秒
- 底部顯示進度條
- 底部顯示頁碼圓點，可點擊跳轉

控制按鈕（滑鼠移到畫面上方會出現）

| 按鈕 | 功能 |
|------|------|
| 暫停 / 繼續 | 暫停 / 繼續自動輪播 |
| 上一頁 | 上一頁 |
| 下一頁 | 下一頁 |
| 退出 | 退出投影模式 |

鍵盤快捷鍵

| 按鍵 | 功能 |
|------|------|
| ← | 上一頁 |
| → | 下一頁 |
| 空白鍵 | 暫停 / 繼續 |
| Esc | 退出投影模式 |

使用建議

主日崇拜前
- 提前 10-15 分鐘開啟投影模式
- 讓會眾在等待時瀏覽代禱事項
- 建議暫停自動輪播，讓會眾自行閱讀

禱告會
- 投影在大屏幕上
- 按頁逐一為每個事項代禱
- 可使用 ← → 鍵手動控制

小組聚會
- 開啟投影模式供小組成員瀏覽
- 可根據需要暫停或手動翻頁

### 常見問題

Q1: 我提交的禱告為什麼沒有顯示？
A: 所有禱告需要經過管理員審核才會顯示。請耐心等待管理員處理。

Q2: 可以修改已提交的禱告嗎？
A: 普通用戶無法自行修改。如需修改，請聯繫教會管理員。

Q3: 禱告事項會永久顯示嗎？
A: 不會。每個禱告事項都有到期日（預設為批准後 7 天）。到期後會自動從祈禱牆移除。管理員可以延長有效期。

Q4: 為什麼提示我包含敏感資料？
A: 系統檢測到你的內容可能包含電話號碼、電子郵件、身份證號、信用卡號、地址等資料。建議移除這些資料以保護隱私，再重新提交。

Q5: 可以完全匿名提交嗎？
A: 可以。只需將「姓名」欄位留空即可。注意：系統會記錄你的 IP 地址的雜湊值（僅用於防止濫用，管理員看不到真實 IP）。

Q6: 投影模式可以在手機上使用嗎？
A: 可以，但建議在電腦或平板上使用以獲得最佳體驗。手機螢幕較小，顯示效果可能不理想。

Q7: 投影模式會自動刷新嗎？
A: 會。投影模式每 5 分鐘自動刷新一次，以顯示最新的禱告事項。

Q8: 管理員密碼忘記了怎麼辦？
A: 需要在伺服器上重新設定環境變數 `ADMIN_PASSWORD`，然後重新部署應用。

Q9: 數據會丟失嗎？
A:
- 免費部署方案（Render/Railway）可能在重啟時丟失數據
- 建議定期備份（從管理後台匯出）
- 或升級到付費方案以獲得持久存儲

Q10: 可以自定義網站樣式嗎？
A: 可以。你可以修改 `public/css/style.css` 和 `public/css/display.css` 檔案。

---

版本資訊
- 當前版本: 1.0.0
- 最後更新: 2026 年 2 月
